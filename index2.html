<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLSX/DAI Price Feed</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
</head>
<body>
    <h1>PLSX/DAI Price Feed</h1>
    <p id="price">Loading price...</p>
    <button onclick="getPrice()">Get Current PLSX Price</button>

    <h2>Set Buy and Sell Prices</h2>
    <div>
        <label for="buyPrice">Buy Price (DAI per PLSX): </label>
        <input type="number" id="buyPrice" step="0.000001">
    </div>
    <div>
        <label for="sellPrice">Sell Price (DAI per PLSX): </label>
        <input type="number" id="sellPrice" step="0.000001">
    </div>

    <h3>Recent Swap Events</h3>
    <ul id="swapEvents"></ul>

    <script>
        const provider = new ethers.providers.JsonRpcProvider('https://pulsechain-rpc.publicnode.com');
        const pairAddress = '0xB2893ceA8080bF43b7b60B589EDaAb5211D98F23';
        const erc20Abi = ["function getReserves() external view returns (uint112, uint112, uint32)"];
        const swapEventABI = [
            "event Swap(address indexed sender, uint amount0In, uint amount1In, uint amount0Out, uint amount1Out, address indexed to)"
        ];
        const pairContract = new ethers.Contract(pairAddress, erc20Abi, provider);

        async function getReserves() {
            const reserves = await pairContract.getReserves();
            return reserves;
        }

        async function getPrice() {
            try {
                const reserves = await getReserves();
                const reservePLSX = reserves[0];
                const reserveDAI = reserves[1];

                const pricePLSX = reserveDAI / reservePLSX;
                const priceDAI = reservePLSX / reserveDAI;

                document.getElementById('price').innerHTML = `
                    <strong>PLSX Price in DAI:</strong> ${pricePLSX.toFixed(6)} DAI<br>
                    <strong>DAI Price in PLSX:</strong> ${priceDAI.toFixed(0)} PLSX
                `;

                checkBuySellConditions(pricePLSX);

            } catch (error) {
                console.error('Error fetching reserves:', error);
                document.getElementById('price').innerText = 'Error fetching price.';
            }
        }

        function checkBuySellConditions(price) {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);

            if (buyPrice && price <= buyPrice) {
                alert("Price reached buy threshold! Execute buy.");
            } else if (sellPrice && price >= sellPrice) {
                alert("Price reached sell threshold! Execute sell.");
            }
        }

        // Listen for Swap events to update the price and show recent swaps
        pairContract.on("Swap", (sender, amount0In, amount1In, amount0Out, amount1Out, to) => {
            console.log(`Swap detected! Sender: ${sender}, Amount In: ${amount0In}, Amount Out: ${amount0Out}`);
            
            // Show the most recent swap event on the page (add to bottom of list)
            const swapEventList = document.getElementById('swapEvents');
            const listItem = document.createElement('li');
            listItem.textContent = `Swap Event: ${amount0In.toString()} PLSX In, ${amount0Out.toString()} PLSX Out. Sender: ${sender}`;
            swapEventList.appendChild(listItem); // Add new event at the bottom

            // After a swap, update the price
            getPrice();
        });

        setInterval(getPrice, 10000);
        getPrice(); // Initial price fetch on page load
    </script>
</body>
</html>
