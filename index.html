// Frontend for Staking Contract

import React, { useState, useEffect } from 'react';
import { ethers } from 'ethers';

// Replace these with your actual contract addresses and ABIs
const TOKEN_ADDRESS = 'YOUR_TOKEN_ADDRESS';
const STAKING_ADDRESS = 'YOUR_STAKING_CONTRACT_ADDRESS';
const TOKEN_ABI = [/* Paste your token ABI here */];
const STAKING_ABI = [/* Paste your staking contract ABI here */];

const App = () => {
    const [provider, setProvider] = useState(null);
    const [signer, setSigner] = useState(null);
    const [address, setAddress] = useState('');
    const [tokenBalance, setTokenBalance] = useState('0');
    const [allowance, setAllowance] = useState('0');
    const [stakeAmount, setStakeAmount] = useState('');
    const [lockDuration, setLockDuration] = useState('');

    useEffect(() => {
        if (window.ethereum) {
            const initProvider = new ethers.providers.Web3Provider(window.ethereum);
            setProvider(initProvider);
        } else {
            alert('Please install MetaMask to use this application.');
        }
    }, []);

    const connectWallet = async () => {
        try {
            await provider.send('eth_requestAccounts', []);
            const signerInstance = provider.getSigner();
            setSigner(signerInstance);

            const userAddress = await signerInstance.getAddress();
            setAddress(userAddress);

            await fetchBalancesAndAllowance(userAddress);
        } catch (error) {
            console.error('Error connecting wallet:', error);
        }
    };

    const fetchBalancesAndAllowance = async (userAddress) => {
        try {
            const tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, provider);
            const stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, provider);

            const balance = await tokenContract.balanceOf(userAddress);
            const userAllowance = await tokenContract.allowance(userAddress, STAKING_ADDRESS);

            setTokenBalance(ethers.utils.formatUnits(balance, 18));
            setAllowance(ethers.utils.formatUnits(userAllowance, 18));
        } catch (error) {
            console.error('Error fetching balances and allowance:', error);
        }
    };

    const approveTokens = async () => {
        try {
            const tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
            const tx = await tokenContract.approve(STAKING_ADDRESS, ethers.utils.parseUnits('1000000', 18)); // Approve a large amount
            await tx.wait();
            alert('Approval successful!');
            await fetchBalancesAndAllowance(address);
        } catch (error) {
            console.error('Error approving tokens:', error);
        }
    };

    const stakeTokens = async () => {
        try {
            const stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);
            const tx = await stakingContract.stake(
                ethers.utils.parseUnits(stakeAmount, 18),
                lockDuration
            );
            await tx.wait();
            alert('Tokens staked successfully!');
            setStakeAmount('');
            setLockDuration('');
            await fetchBalancesAndAllowance(address);
        } catch (error) {
            console.error('Error staking tokens:', error);
        }
    };

    return (
        <div style={{ padding: '20px', fontFamily: 'Arial' }}>
            <h1>Staking DApp</h1>
            {!address ? (
                <button onClick={connectWallet}>Connect Wallet</button>
            ) : (
                <div>
                    <p>Connected Wallet: {address}</p>
                    <p>Token Balance: {tokenBalance}</p>
                    <p>Allowance: {allowance}</p>

                    <div>
                        <h3>Approve Tokens</h3>
                        <button onClick={approveTokens}>Approve</button>
                    </div>

                    <div>
                        <h3>Stake Tokens</h3>
                        <input
                            type="number"
                            placeholder="Amount to Stake"
                            value={stakeAmount}
                            onChange={(e) => setStakeAmount(e.target.value)}
                        />
                        <input
                            type="number"
                            placeholder="Lock Duration (seconds)"
                            value={lockDuration}
                            onChange={(e) => setLockDuration(e.target.value)}
                        />
                        <button onClick={stakeTokens}>Stake</button>
                    </div>
                </div>
            )}
        </div>
    );
};

export default App;
