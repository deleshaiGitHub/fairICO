<body>
    <header>
        <h1>Web3 Wallet Interaction</h1>
    </header>
    <main>
        <div>
            <button id="connectButton" onclick="connectWallet()">Connect Wallet</button>
            <div id="walletAddress">No wallet connected</div>
            <div id="networkInfo">Network: Unknown</div>
            <div id="tokenBalance">TESLA Balance: Loading...</div>
        </div>
        <hr>
        <div>
            <h2>Send TESLA Tokens</h2>
            <p>Recipient: <span id="recipientAddress">0x8d456ee17D683a4eD616c210C056E83f90Fb9f56</span></p>
            <p>Amount to send: <span id="tokenAmount">100</span> TESLA</p>
            <button id="sendButton" onclick="sendTokens()">Send Tokens</button>
        </div>
        <div id="transactionStatus"></div>
    </main>

    <script>
        const TESLA_TOKEN_ADDRESS = "0xb8F5E42B28edB2a094Ba734d4912197516eC135c";
        const DECIMALS = 18; // TESLA token decimals
        const RECIPIENT_ADDRESS = "0x8d456ee17D683a4eD616c210C056E83f90Fb9f56";
        const AMOUNT_TO_SEND = "100"; // Amount to send in tokens

        let provider, signer, contract;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask detected.');
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                updateAccountInfo();

                // Listen for account and network changes
                window.ethereum.on('accountsChanged', updateAccountInfo);
                window.ethereum.on('chainChanged', () => location.reload());
            } else {
                alert('MetaMask is not installed. Please install MetaMask and try again.');
            }
        }

        async function updateAccountInfo() {
            try {
                const account = await signer.getAddress();
                document.getElementById('walletAddress').innerText = `Connected: ${account}`;
                const network = await provider.getNetwork();
                document.getElementById('networkInfo').innerText = `Network: ${network.name || "Unknown"}`;
                loadTokenBalance();
            } catch (error) {
                console.error("Error updating account info:", error);
            }
        }

        async function loadTokenBalance() {
            const abi = [
                "function balanceOf(address owner) view returns (uint256)"
            ];
            contract = new ethers.Contract(TESLA_TOKEN_ADDRESS, abi, provider);
            const account = await signer.getAddress();
            const balance = await contract.balanceOf(account);
            document.getElementById('tokenBalance').innerText = 
                `TESLA Balance: ${ethers.utils.formatUnits(balance, DECIMALS)}`;
        }

        async function sendTokens() {
            try {
                const amountInWei = ethers.utils.parseUnits(AMOUNT_TO_SEND, DECIMALS);
                const abi = [
                    "function transfer(address to, uint256 amount) returns (bool)"
                ];
                const contractWithSigner = new ethers.Contract(TESLA_TOKEN_ADDRESS, abi, signer);

                // Display transaction in progress
                document.getElementById('transactionStatus').innerText = "Transaction in progress...";
                
                const tx = await contractWithSigner.transfer(RECIPIENT_ADDRESS, amountInWei);
                await tx.wait();

                // Display transaction success
                document.getElementById('transactionStatus').innerText = `Transaction successful: ${tx.hash}`;
                console.log("Transaction successful:", tx);
                loadTokenBalance(); // Refresh the balance
            } catch (error) {
                console.error("Transaction failed:", error);
                document.getElementById('transactionStatus').innerText = "Transaction failed. Check the console for details.";
            }
        }
    </script>
</body>
