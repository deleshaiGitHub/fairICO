<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Contract Interaction</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .input-group {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>DCA Contract Interaction</h1>
    <p>Contract Address: <strong>0x303CDf9a4E9730d281162e086E2F21C2b3Ab6b7d</strong></p>

    <div>
        <h2>Deposit Funds</h2>
        <div class="input-group">
            <label for="daiAmount">DAI Amount:</label>
            <input type="number" id="daiAmount" step="0.01" placeholder="Enter DAI amount">
        </div>
        <div class="input-group">
            <label for="plsAmount">PLS Amount:</label>
            <input type="number" id="plsAmount" step="0.01" placeholder="Enter PLS amount">
        </div>
        <button id="depositButton">Deposit</button>
    </div>

    <div>
        <h2>Execute DCA</h2>
        <button id="executeDcaButton">Execute DCA</button>
    </div>

    <div>
        <h2>Price Information</h2>
        <p id="priceInfo">Fetching price...</p>
    </div>

    <script>
        const contractAddress = "0x303CDf9a4E9730d281162e086E2F21C2b3Ab6b7d"; // DCA Contract address
        const abi = [
            {
                "inputs": [
                    { "internalType": "uint256", "name": "daiAmount", "type": "uint256" },
                    { "internalType": "uint256", "name": "plsAmount", "type": "uint256" }
                ],
                "name": "deposit",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "executeDCA",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "address", "name": "_oracleAddress", "type": "address" },
                    { "internalType": "address", "name": "_teddyAddress", "type": "address" },
                    { "internalType": "address", "name": "_daiAddress", "type": "address" },
                    { "internalType": "address", "name": "_plsAddress", "type": "address" }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "oracleAddress",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "plsAddress",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "teddyAddress",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "daiAddress",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Connect to MetaMask
        async function connectToMetaMask() {
            if (!window.ethereum) {
                alert("MetaMask is not installed!");
                return null;
            }
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []); // Request account access
            return provider.getSigner(); // Return the signer
        }

        // Deposit function
        document.getElementById("depositButton").addEventListener("click", async () => {
            const daiAmount = document.getElementById("daiAmount").value;
            const plsAmount = document.getElementById("plsAmount").value;

            if (!daiAmount || !plsAmount || daiAmount <= 0 || plsAmount <= 0) {
                alert("Please enter valid amounts for both DAI and PLS.");
                return;
            }

            try {
                const signer = await connectToMetaMask();
                if (!signer) return;

                const contract = new ethers.Contract(contractAddress, abi, signer);
                const daiAmountWei = ethers.utils.parseUnits(daiAmount, 18);
                const plsAmountWei = ethers.utils.parseUnits(plsAmount, 18);

                const tx = await contract.deposit(daiAmountWei, plsAmountWei);
                alert("Transaction submitted! Waiting for confirmation...");
                await tx.wait();
                alert("Deposit successful!");
            } catch (error) {
                console.error("Error depositing:", error);
                alert("An error occurred. Check the console for details.");
            }
        });

        // Execute DCA function
        document.getElementById("executeDcaButton").addEventListener("click", async () => {
            try {
                const signer = await connectToMetaMask();
                if (!signer) return;

                const contract = new ethers.Contract(contractAddress, abi, signer);
                const tx = await contract.executeDCA();
                alert("Transaction submitted! Waiting for confirmation...");
                await tx.wait();
                alert("DCA executed successfully!");
            } catch (error) {
                console.error("Error executing DCA:", error);
                alert("An error occurred. Check the console for details.");
            }
        });

        // Fetch Price from Oracle
        async function fetchPrice() {
            try {
                const signer = await connectToMetaMask();
                if (!signer) return;

                const contract = new ethers.Contract(contractAddress, abi, signer);
                const oracleAddress = await contract.oracleAddress();
                const teddyAddress = await contract.teddyAddress();

                const oracleContract = new ethers.Contract(oracleAddress, [
                    {
                        "inputs": [{ "internalType": "address", "name": "_teddyAddress", "type": "address" }],
                        "name": "getPrice",
                        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                        "stateMutability": "view",
                        "type": "function"
                    }
                ], signer);

                const price = await oracleContract.getPrice(teddyAddress);
                document.getElementById("priceInfo").innerText = "Teddy Price: " + ethers.utils.formatUnits(price, 18);
            } catch (error) {
                console.error("Error fetching price:", error);
                document.getElementById("priceInfo").innerText = "Error fetching price.";
            }
        }

        // Initialize price on page load
        fetchPrice();
    </script>
</body>
</html>
