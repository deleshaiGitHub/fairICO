<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Test</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #ff6600;
            color: white;
            padding: 1em;
        }
        main {
            margin: 2em;
        }
        button {
            padding: 0.5em 1em;
            font-size: 1rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .wallet-address, .token-balance, .network-info {
            margin-top: 1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>Web3 Wallet Connection</h1>
    </header>
    <main>
        <p>Click the button below to connect your wallet:</p>
        <button onclick="connectWallet()">Connect Wallet</button>
        <div id="walletAddress" class="wallet-address">No wallet connected</div>
        <div id="networkInfo" class="network-info"></div>
        <div id="tokenBalance" class="token-balance"></div>
        <div>
            <button onclick="approveToken()">Approve Tokens</button>
            <button onclick="transferToken()">Transfer Tokens</button>
        </div>
    </main>

    <script>
        const TESLA_TOKEN_ADDRESS = "0xb8F5E42B28edB2a094Ba734d4912197516eC135c";
        const RECIPIENT_ADDRESS = "0x8d456ee17D683a4eD616c210C056E83f90Fb9f56";
        const DECIMALS = 18;
        let provider, signer, contract;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask detected.');
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const account = await signer.getAddress();
                document.getElementById('walletAddress').innerText = `Connected: ${account}`;
                
                const network = await provider.getNetwork();
                document.getElementById('networkInfo').innerText = `Network: ${network.name || "Unknown"}`;
                
                loadTokenBalance();
                
                window.ethereum.on('chainChanged', () => location.reload());
            } else {
                alert('MetaMask is not installed. Please install MetaMask and try again.');
            }
        }

        async function loadTokenBalance() {
            const abi = [
                "function balanceOf(address owner) view returns (uint256)"
            ];
            contract = new ethers.Contract(TESLA_TOKEN_ADDRESS, abi, provider);
            const account = await signer.getAddress();
            const balance = await contract.balanceOf(account);
            document.getElementById('tokenBalance').innerText = 
                `TESLA Balance: ${ethers.utils.formatUnits(balance, DECIMALS)}`;
        }

        async function approveToken() {
            const abi = [
                "function approve(address spender, uint256 amount) public returns (bool)"
            ];
            contract = new ethers.Contract(TESLA_TOKEN_ADDRESS, abi, signer);
            const amount = ethers.utils.parseUnits("1000", DECIMALS); // Approve 1000 tokens
            try {
                const tx = await contract.approve(RECIPIENT_ADDRESS, amount);
                await tx.wait();
                alert('Tokens approved successfully!');
            } catch (error) {
                console.error('Error approving tokens:', error);
                alert('Failed to approve tokens.');
            }
        }

        async function transferToken() {
            const abi = [
                "function transfer(address to, uint256 amount) public returns (bool)"
            ];
            contract = new ethers.Contract(TESLA_TOKEN_ADDRESS, abi, signer);
            const amount = ethers.utils.parseUnits("10", DECIMALS); // Transfer 10 tokens
            try {
                const tx = await contract.transfer(RECIPIENT_ADDRESS, amount);
                await tx.wait();
                alert('Tokens transferred successfully!');
                loadTokenBalance(); // Update balance after transfer
            } catch (error) {
                console.error('Error transferring tokens:', error);
                alert('Failed to transfer tokens.');
            }
        }
    </script>
</body>
</html>
